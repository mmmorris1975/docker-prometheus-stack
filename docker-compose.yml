version: "3.2"

services:
  blackbox-exporter:
    image: armhf-prometheus-blackbox_exporter:latest
# cap_add not supported in swarm, wonder if that breaks blackbox pings?
#    cap_add:
#      - NET_RAW
    volumes:
      - ./prometheus/blackbox_exporter_config.yml:/etc/blackbox_exporter/config.yml:ro
    ports:
      - target: 9115
        published: 9115
        protocol: tcp
        mode: host
    healthcheck:
      test: ['CMD', 'wget', '-q', '-O', '/dev/null', 'http://localhost:9115/metrics']
      interval: 10s
      timeout: 5s
      retries: 3
  snmp-exporter:
    image: armhf-prometheus-snmp_exporter:latest
    volumes:
      - ./prometheus/snmp_exporter_config.yml:/etc/snmp_exporter/config.yml:ro
    ports:
      - target: 9116
        published: 9116
        protocol: tcp
        mode: host
    healthcheck:
      test: ['CMD', 'wget', '-q', '-O', '/dev/null', 'http://localhost:9116/metrics']
      interval: 10s
      timeout: 5s
      retries: 3
  nginx:
    image: armhf-nginx
    volumes:
      - ./nginx/default.d/:/etc/nginx/default.d/:ro
      - ./nginx/conf.d/:/etc/nginx/conf.d/:ro
      - ./nginx/htpasswd:/htpasswd:ro
      - ./nginx/server.key:/server.key:ro
      - ./nginx/server.crt:/server.crt:ro
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    healthcheck:
      test: ['CMD', 'wget', '-q', '-O', '/dev/null', 'http://localhost/']
      interval: 10s
      timeout: 5s
      retries: 3
  speedtest-pusher:
    image: armhf-prometheus-speedtest-pusher
    deploy:
      replicas: 1
      restart_policy:
        condition: none
    environment:
      - PUSH_GW=mac-mini:9091
